<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OptKnock Interactive Simulator</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <h1><i class="fas fa-dna"></i> OptKnock Interactive Simulator</h1>
                <p class="subtitle">A metabolic engineering demo for optimizing gene knockout strategies</p>
            </div>
        </header>

        <!-- Main content area -->
        <main class="main-content">
            <!-- Step navigation -->
            <div class="steps-navigation">
                <div class="step" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-title">Algorithm Introduction</div>
                </div>
                <div class="step" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-title">Model Preparation</div>
                </div>
                <div class="step" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-title">Parameter Setup</div>
                </div>
                <div class="step" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-title">Gene Set Selection</div>
                </div>
                <div class="step" data-step="5">
                    <div class="step-number">5</div>
                    <div class="step-title">Run OptKnock</div>
                </div>
                <div class="step" data-step="6">
                    <div class="step-number">6</div>
                    <div class="step-title">Results Analysis</div>
                </div>
            </div>

            <!-- Content area -->
            <div class="content-area">
                <!-- Left: interactive panel -->
                <div class="interaction-panel">
                    <!-- Step 1: Algorithm introduction -->
                    <div class="step-content" id="step-1">
                        <h2><i class="fas fa-info-circle"></i> OptKnock Algorithm Overview</h2>
                        <div class="theory-section">
                            <h3>What is OptKnock?</h3>
                            <p>OptKnock is a bi-level optimization algorithm that identifies gene knockout strategies to boost target metabolite production. It uses mathematical optimization to discover the best gene deletion set.</p>
                            
                            <h3>Core Algorithm Concept</h3>
                            <ul>
                                <li><strong>Outer problem</strong>: Maximize target product flux</li>
                                <li><strong>Inner problem</strong>: Optimize cellular growth under knockout constraints</li>
                                <li><strong>Constraints</strong>: Maintain a minimum growth rate to keep the cell viable</li>
                            </ul>

                            <div class="formula-box">
                                <h4>Mathematical formulation:</h4>
                                <div class="formula">
                                    max Σ v<sub>target</sub><br>
                                    s.t. max Σ v<sub>biomass</sub><br>
                                    &nbsp;&nbsp;&nbsp;&nbsp;S·v = 0<br>
                                    &nbsp;&nbsp;&nbsp;&nbsp;v<sub>min</sub> ≤ v ≤ v<sub>max</sub>
                                </div>
                            </div>
                        </div>
                        <button class="action-btn" onclick="nextStep(2)">
                            <i class="fas fa-arrow-right"></i> Start Simulation
                        </button>
                    </div>

                    <!-- Step 2: model preparation -->
                    <div class="step-content" id="step-2" style="display: none;">
                        <h2><i class="fas fa-database"></i> Metabolic Network Preparation</h2>
                        <div class="theory-section">
                            <h3>iJO1366 Model overview</h3>
                            <p>iJO1366 is a genome-scale reconstruction of Escherichia coli that contains:</p>
                            <ul>
                                <li><strong>1,366 genes</strong></li>
                                <li><strong>2,583 reactions</strong></li>
                                <li><strong>1,805 metabolites</strong></li>
                                <li><strong>Multiple cellular compartments</strong>: cytosol, periplasm, extracellular space</li>
                            </ul>
                        </div>
                        <button class="action-btn" onclick="loadModel()">
                            <i class="fas fa-download"></i> Load iJO1366 model
                        </button>
                        
                        <!-- Step control button container -->
                        <div id="step-2-buttons" class="step-control-buttons" style="display: none;">
                        </div>
                    </div>

                    <!-- Step 3: parameter setup -->
                    <div class="step-content" id="step-3" style="display: none;">
                        <h2><i class="fas fa-sliders-h"></i> Configure Experiment Parameters</h2>
                        <div class="parameter-grid">
                            <div class="param-group">
                                <label for="glucose-conc">Glucose uptake (mmol/gDW·hr)</label>
                                <select id="glucose-conc">
                                    <option value="5">5.0</option>
                                    <option value="10" selected>10.0</option>
                                    <option value="15">15.0</option>
                                    <option value="20">20.0</option>
                                    <option value="25">25.0</option>
                                </select>
                            </div>
                            <div class="param-group">
                                <label for="target-product">Target product</label>
                                <select id="target-product">
                                    <option value="succinate" selected>Succinate</option>
                                    <option value="lactate">Lactate</option>
                                    <option value="acetate">Acetate</option>
                                    <option value="ethanol">Ethanol</option>
                                    <option value="formate">Formate</option>
                                </select>
                            </div>
                            <div class="param-group">
                                <label for="knockout-size">Gene knockout count</label>
                                <select id="knockout-size">
                                    <option value="1">1 gene</option>
                                    <option value="2" selected>2 genes</option>
                                    <option value="3">3 genes</option>
                                </select>
                            </div>
                            <div class="param-group">
                                <label for="min-growth">Minimum growth rate (%)</label>
                                <input type="range" id="min-growth" min="10" max="80" value="30" oninput="updateGrowthValue(this.value)">
                                <span id="growth-value">30%</span>
                            </div>
                        </div>
                        <button class="action-btn" onclick="setParameters()">
                            <i class="fas fa-check"></i> Confirm parameters
                        </button>
                        
                        <!-- Step control button container -->
                        <div id="step-3-buttons" class="step-control-buttons" style="display: none;">
                            <button class="step-btn prev-btn" onclick="prevStep(2)">
                                <i class="fas fa-arrow-left"></i> Previous
                            </button>
                            <button class="step-btn next-btn" onclick="nextStep(4)">
                                Next <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Step 4: gene set selection -->
                    <div class="step-content" id="step-4" style="display: none;">
                        <h2><i class="fas fa-dna"></i> Select Candidate Gene Sets</h2>
                        <div class="gene-sets-grid">
                            <div class="gene-set-card" data-geneset="glycolysis">
                                <h3><i class="fas fa-fire"></i> Glycolysis pathway</h3>
                                <p>Primary energy route converting glucose to pyruvate</p>
                                <div class="gene-count">17 reactions</div>
                            </div>
                            <div class="gene-set-card" data-geneset="pentose_phosphate">
                                <h3><i class="fas fa-recycle"></i> Pentose phosphate pathway</h3>
                                <p>Generates NADPH and ribose-5-phosphate</p>
                                <div class="gene-count">12 reactions</div>
                            </div>
                            <div class="gene-set-card" data-geneset="tca_cycle">
                                <h3><i class="fas fa-sync"></i> TCA cycle</h3>
                                <p>Central pathway for complete oxidation of pyruvate</p>
                                <div class="gene-count">13 reactions</div>
                            </div>
                            <div class="gene-set-card" data-geneset="mixed_central">
                                <h3><i class="fas fa-network-wired"></i> Mixed central metabolism</h3>
                                <p>Core network that integrates multiple pathways</p>
                                <div class="gene-count">14 reactions</div>
                            </div>
                            <div class="gene-set-card" data-geneset="fermentation">
                                <h3><i class="fas fa-flask"></i> Fermentation routes</h3>
                                <p>Produces reduced metabolites under anaerobic conditions</p>
                                <div class="gene-count">11 reactions</div>
                            </div>
                        </div>
                        <button class="action-btn" id="select-geneset-btn" onclick="selectGeneSet()" disabled>
                            <i class="fas fa-arrow-right"></i> Select gene set
                        </button>
                        
                        <!-- Step control button container -->
                        <div id="step-4-buttons" class="step-control-buttons" style="display: none;">
                        </div>
                    </div>

                    <!-- Step 5: run OptKnock -->
                    <div class="step-content" id="step-5" style="display: none;">
                        <h2><i class="fas fa-cogs"></i> Run OptKnock</h2>
                        <div class="execution-info">
                            <div class="current-config">
                                <h3>Current configuration:</h3>
                                <div class="config-item">
                                    <span class="label">Gene set:</span>
                                    <span id="selected-geneset-name">-</span>
                                </div>
                                <div class="config-item">
                                    <span class="label">Glucose uptake:</span>
                                    <span id="selected-glucose">-</span> mmol/gDW·hr
                                </div>
                                <div class="config-item">
                                    <span class="label">Target product:</span>
                                    <span id="selected-target">-</span>
                                </div>
                                <div class="config-item">
                                    <span class="label">Knockout count:</span>
                                    <span id="selected-knockout">-</span> genes
                                </div>
                            </div>
                        </div>
                        <button class="action-btn" onclick="runOptKnock()">
                            <i class="fas fa-play"></i> Run OptKnock
                        </button>
                        
                        <!-- Step control button container -->
                        <div id="step-5-buttons" class="step-control-buttons" style="display: none;">
                        </div>
                    </div>

                    <!-- Step 6: results analysis -->
                    <div class="step-content" id="step-6" style="display: none;">
                        <h2><i class="fas fa-chart-line"></i> Results interpretation</h2>
                        <div class="results-summary" id="results-summary">
                            <!-- Results are populated dynamically via JavaScript -->
                        </div>
                        
                        <!-- Results chart area -->
                        <div class="results-charts" id="results-charts" style="display: none;">
                            <h3><i class="fas fa-chart-bar"></i> Data analysis chart</h3>
                            <div class="charts-grid">
                                <div class="chart-container">
                                    <canvas id="knockout-comparison-chart"></canvas>
                                </div>
                                <div class="chart-container">
                                    <canvas id="production-trend-chart"></canvas>
                                </div>
                                <div class="chart-container">
                                    <canvas id="metabolic-network-chart"></canvas>
                                </div>
                            </div>
                        </div>

                        <button class="action-btn" onclick="resetSimulation()">
                            <i class="fas fa-redo"></i> Restart Simulation
                        </button>
                    </div>
                </div>

                <!-- Right: terminal display -->
                <div class="terminal-panel">
                    <div class="terminal-header">
                        <div class="terminal-controls">
                            <span class="control close"></span>
                            <span class="control minimize"></span>
                            <span class="control maximize"></span>
                        </div>
                        <div class="terminal-title">OptKnock Simulator Terminal</div>
                    </div>
                    <div class="terminal-body" id="terminal">
                        <div class="terminal-line">
                            <span class="prompt">optknock@simulator:~$</span>
                            <span class="cursor">█</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Chart preview modal -->
    <div id="chart-preview-modal" class="chart-modal" style="display: none;">
        <div class="chart-modal-content">
            <div class="chart-modal-header">
                <h3 id="chart-modal-title">Pathway preview</h3>
                <button class="chart-modal-close" onclick="closeChartPreview()">&times;</button>
            </div>
            <div class="chart-modal-body">
                <canvas id="preview-chart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>

    <!-- Floating speed button -->
    <button class="speed-button" id="speed-button" onclick="toggleSpeedMode()" title="Speed mode">
        <i class="fas fa-forward"></i>
    </button>

    <!-- JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="script.js"></script>
</body>
</html>
